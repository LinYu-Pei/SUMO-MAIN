import xml.etree.ElementTree as ET
from xml.dom import minidom
import numpy as np
import random

# --- 1. 核心參數設定 ---

# 輸出的路徑檔名稱
OUTPUT_FILENAME = "1event_traffic_60s.rou.xml"

# --- 實驗情境設定 ---

# 總共要生成的車輛數量
NUM_VEHICLES = 100


# 車輛 ID 的起始編號
# 【教授修改】根據您的要求，ID 從 6000 開始
ID_START_NUMBER = 6100

VEHICLE_ID_PREFIX = "" 

# 出發時間的模式:
# 'linear': 線性/均勻分佈 (例如：每秒一輛車)
# 'normal': 常態分佈 (中間密集，兩頭稀疏，模擬真實散場)
DISTRIBUTION_MODEL = 'linear'

# 車輛開始出發的時間 (秒)
# 【教授修改】根據您的要求，從 750 秒開始
DEPART_START_TIME = 10.0

# 車輛出發的持續總時間 (秒)
# 注意：在 'linear' 模式下，這個值會被自動計算
# 在 'normal' 模式下，這個值決定了散場的快慢 (例如 60 秒內散場完畢)
EVENT_DURATION = 60.0

# --- 車輛與路徑設定 ---

# 車輛類型
VEHICLE_TYPE = "passenger"

# 所有車輛共用的固定路徑
ROUTE_EDGES ="-183946735#1 -183946735#0 -183840100#4 -183840100#1 866318725#1 311576774 732411491 866318724 243908725#0 243908725#2 243908725#3 243908725#4 243908725#5 243908725#6 243908725#7 461206602 732411488 732411487 882789874#0 244421758#2 244421758#3 37099791#0 37099791#1 37099791#3 449379851#1 413955653#10 413955653#11 -330466878#17 -330466878#16 -330466878#14 -330466878#9 -330466878#8 -330466878#7 -330466878#5 -330466878#4 -330466878#3 -330466878#1 -172356275#2 -172356275#1 23766390#1 23766390#2 23766390#3 23766390#4 23766390#7 23766390#8 23766390#9 23766390#10 23766390#12 23766390#13 23766392#0 23766392#2 23766392#3 23766392#4 23766392#5 23766392#7 23766392#8 23766392#9 23766392#10 23766392#13 23766392#16 23766392#17 23766392#18 23766392#19 23766397#0 23766397#1 23766397#2 23766397#3 23766397#4 23766397#6 236367442#0 236367442#1 236367442#2 236367442#3 236367442#4 236367442#5 316690652#0 316690652#1 316690652#2 316690652#3 1257895196#0 1257895199 1257895197#0 1257895197#1 1257895197#2 1257895197#3 1257895197#4 1257895197#5 158758847#1 158758847#2 158758847#4 158758847#5 158758847#6 -505644564#11 -505644564#10 -505644564#9 -505644564#6 -505644564#5 -505644564#4 -505644564#2 -505644564#1 -505644564#0 110526118#1 110526118#2 110526118#3 110526118#6 110526118#8 110526118#9 110526118#10 110526118#12 110526118#13 110526118#15 110526118#16 110526118#17 221195129#22 221195129#23 221195129#24 221195129#26 221195129#28 221195129#30 221195129#31 221195129#32 221195129#33 221195129#34 221195129#35 221195129#38 221195129#39 221195129#40 158978976#1 158978976#2 158978976#3 158978976#4 158978976#6 62080970#1 62080970#2 203315542#0 -474788300#0 -475037306#7 -475037306#6 -475037306#5 -475037306#4 -475037306#3 -475037306#2 -475037306#1 -475037306#0"
#1 : "-183946735#1 -183946735#0 -183840100#4 -183840100#1 866318725#1 311576774 732411491 866318724 243908725#0 243908725#2 243908725#3 243908725#4 243908725#5 243908725#6 243908725#7 461206602 732411488 732411487 882789874#0 244421758#2 244421758#3 37099791#0 37099791#1 37099791#3 449379851#1 413955653#10 413955653#11 -330466878#17 -330466878#16 -330466878#14 -330466878#9 -330466878#8 -330466878#7 -330466878#5 -330466878#4 -330466878#3 -330466878#1 -172356275#2 -172356275#1 23766390#1 23766390#2 23766390#3 23766390#4 23766390#7 23766390#8 23766390#9 23766390#10 23766390#12 23766390#13 23766392#0 23766392#2 23766392#3 23766392#4 23766392#5 23766392#7 23766392#8 23766392#9 23766392#10 23766392#13 23766392#16 23766392#17 23766392#18 23766392#19 23766397#0 23766397#1 23766397#2 23766397#3 23766397#4 23766397#6 236367442#0 236367442#1 236367442#2 236367442#3 236367442#4 236367442#5 316690652#0 316690652#1 316690652#2 316690652#3 1257895196#0 1257895199 1257895197#0 1257895197#1 1257895197#2 1257895197#3 1257895197#4 1257895197#5 158758847#1 158758847#2 158758847#4 158758847#5 158758847#6 -505644564#11 -505644564#10 -505644564#9 -505644564#6 -505644564#5 -505644564#4 -505644564#2 -505644564#1 -505644564#0 110526118#1 110526118#2 110526118#3 110526118#6 110526118#8 110526118#9 110526118#10 110526118#12 110526118#13 110526118#15 110526118#16 110526118#17 221195129#22 221195129#23 221195129#24 221195129#26 221195129#28 221195129#30 221195129#31 221195129#32 221195129#33 221195129#34 221195129#35 221195129#38 221195129#39 221195129#40 158978976#1 158978976#2 158978976#3 158978976#4 158978976#6 62080970#1 62080970#2 203315542#0 -474788300#0 -475037306#7 -475037306#6 -475037306#5 -475037306#4 -475037306#3 -475037306#2 -475037306#1 -475037306#0"
#2 : "-189781450#1 189781450#1 311860250#7 311860250#8 311860250#9 311860250#10 311860250#12 311860250#13 311860250#14 311860250#17 311860250#18 158964735 158964745#0 158964745#1 158964745#2 158964745#3 158964745#4 158964745#7 158964745#8 158964745#9 158917967#1 243903727#0 243903727#1 243903727#2 243903727#4 243903727#5 197557008#1 197557008#3 197557008#3-AddedOffRampEdge 197557008#4 197557008#6 197557008#11 197557008#14 472093898#0 472093898#1 158917944#1 158917944#2 158917944#4 158917944#5 158917944#6 158917944#7 158917944#8 158917944#9 -266063760#3 -266063760#2 -266063760#1 -266063760#0 -1257895198#6 -1257895198#5 -1257895198#2 -1257895198#1 -316690655#10 -316690655#9 -316690655#8 -316690655#7 -316690655#5 -316690655#2 28017818#1 173012839#0 173012839#1 173012839#2 173012839#3 173012835#1 173012838#1 173030662#0 173030662#1 -236367442#5 -236367442#4 -236367442#3 -236367442#2 -236367442#1 -236367442#0 -23766397#6 -23766397#4 -23766397#3 -23766397#2 -23766397#1 -23766397#0 -23766392#19 -23766392#18 -23766392#17 -23766392#16 -23766392#13 -23766392#10 -23766392#9 -23766392#8 -23766392#7 -23766392#5 -23766392#4 -23766392#3 -23766392#2 -23766392#0 -23766390#13 -23766390#12 -23766390#10 -23766390#9 -23766390#8 -23766390#7 -23766390#4 -23766390#3 -23766390#2 -23766390#1 172356275#1 172356275#2 330466878#1 330466878#3 330466878#4 330466878#5 330466878#7 330466878#8 330466878#9 330466878#14 330466878#16 330466878#17 413955653#12 413955653#13 160307899#1 160307899#2 461206603#1 461206604#1 241536947#0 241536947#1 241536947#2 241536947#3 241536947#5 241536947#6 241536947#7 732411485 732411490 732411489 243908724#0 243908724#1 407206572#1 407206572#4 407206572#6 407206572#9 407206572#12 407206572#13 407206572#14 866318728#1 866318728#2 311860239#0 311860239#1 311860239#2"
#0 : "203315542#0 -474788300#0 -317319509 -317319505 476442145 -317032950 -203315546#4 -203315546#3 -203315546#2 -203315546#1 -203315546#0 -478048074#1 255180004 317319500#0 317319500#1 475421740 317319496#4 474735871 197557009 474735872#0 474735872#1 474733651#0 474733651#1 474733651#2 475037306#0 475037306#1 475037306#2 475037306#3 475037306#4 475037306#5 475037306#6 475037306#7 474788300#0 -203315542#0 62080970#5 62080970#6 62080970#8 62080970#10 62080970#11 62080970#12  "

# --- 2. 程式碼主體 ---

def generate_depart_times(num, start_time, duration, model='normal'):
    """根據指定的模型生成車輛出發時間列表"""
    if model == 'normal':
        # 常態分佈，中間密集，兩頭稀疏
        peak_time = start_time + (duration / 2)
        std_dev = duration / 4 # 標準差，控制分佈的胖瘦
        times = np.random.normal(loc=peak_time, scale=std_dev, size=num)
        # 確保時間不會超出設定的範圍
        times = np.clip(times, start_time, start_time + duration)
        return sorted(times)
    
    elif model == 'uniform':
        # 均勻分佈，在時間段內隨機出現
        times = [random.uniform(start_time, start_time + duration) for _ in range(num)]
        return sorted(times)
    
    # 【教授新增】線性分佈，完全按照固定間隔出現
    elif model == 'linear':
        # 在這個模式下，duration 會被忽略
        # 每秒一輛車，持續 num 秒
        times = [start_time + i for i in range(num)]
        return times
        
    else:
        raise ValueError("不支援的分佈模型。請選擇 'normal', 'uniform', 或 'linear'。")

def create_route_file():
    """主函式，用於生成最終的 .rou.xml 檔案"""
    
    # 根據線性模型，重新計算總時長，以便日誌打印
    actual_duration = NUM_VEHICLES if DISTRIBUTION_MODEL == 'linear' else EVENT_DURATION
    
    print(f"開始生成 {NUM_VEHICLES} 輛車的交通流...")
    print(f"出發模型: {DISTRIBUTION_MODEL}")
    print(f"時間區間: {DEPART_START_TIME:.2f} 秒 到 {DEPART_START_TIME + actual_duration:.2f} 秒 (共 {actual_duration} 秒)")
    
    depart_times = generate_depart_times(NUM_VEHICLES, DEPART_START_TIME, EVENT_DURATION, DISTRIBUTION_MODEL)
    
    # 建立 XML 的根節點 <routes>
    root = ET.Element("routes")
    root.set("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance")
    root.set("xsi:noNamespaceSchemaLocation", "http://sumo.dlr.de/xsd/routes_file.xsd")

    # 迴圈生成每一輛車
    for i in range(NUM_VEHICLES):
        # 【教授修改】ID 生成邏輯
        vehicle_id = f"{VEHICLE_ID_PREFIX}{ID_START_NUMBER + i}" if VEHICLE_ID_PREFIX else f"{ID_START_NUMBER + i}"
        depart_time = depart_times[i]
        
        # 建立 <vehicle> 節點
        vehicle_elem = ET.SubElement(root, "vehicle")
        vehicle_elem.set("id", vehicle_id)
        vehicle_elem.set("type", VEHICLE_TYPE)
        vehicle_elem.set("depart", f"{depart_time:.2f}")
        vehicle_elem.set("departSpeed", "max")
        
        # 建立 <route> 子節點
        route_elem = ET.SubElement(vehicle_elem, "route")
        route_elem.set("edges", ROUTE_EDGES)

    # 將 XML 結構轉換為帶有良好排版的字串
    xml_string = ET.tostring(root, 'utf-8')
    pretty_xml_string = minidom.parseString(xml_string).toprettyxml(indent="    ")

    # 寫入檔案
    with open(OUTPUT_FILENAME, "w", encoding="utf-8") as f:
        f.write(pretty_xml_string)
        
    print(f"\n成功！路徑檔 '{OUTPUT_FILENAME}' 已生成。")
    print(f"第一輛車出發時間: {depart_times[0]:.2f} 秒")
    print(f"最後一輛車出發時間: {depart_times[-1]:.2f} 秒")


if __name__ == "__main__":
    try:
        import numpy
    except ImportError:
        print("錯誤: 需要 numpy 函式庫。請使用 'pip install numpy' 進行安裝。")
    else:
        create_route_file()